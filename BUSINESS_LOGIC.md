# Business Logic Documentation

## Overview
This document describes the complete business logic flow for the Supply Chain Management system.

## Key Concepts

### Order Items vs Purchase Orders (POs)
- **Order Items**: Individual line items (per country, per SKU, per month) that can be forecasted, planned, and allocated
- **Purchase Orders (POs)**: Containers that group multiple Order Items together for approval and management

## Workflow

### 1. Forecast Generation (System)
- Azure function automatically generates **Forecasted Order Items**
- Generated per country, per SKU, per month
- Status: `Forecasted`
- These are system-generated suggestions, not yet actionable

### 2. Planning Phase (Logistics Officer)
- LO views forecasted order items
- Clicks on a forecasted order item to "plan" it
- Status changes: `Forecasted` → `Planned`
- **Must link to a PO**:
  - If PO exists: Link order item to existing PO
  - If no PO: Create new PO and link order item
- A PO can contain multiple SKUs (multiple order items)

### 3. Approval Request (Logistics Officer)
- After planning order items, LO requests manager approval
- Approval is requested at the **PO level** (not individual order items)
- Manager sees:
  - All SKUs in the PO
  - All order items summarized
  - Total quantities, countries, delivery months
- Status: PO status becomes `Approval Requested`

### 4. Manager Approval
- Manager reviews the entire PO
- Can approve or reject the whole PO
- If approved: PO status → `Approved`
- If rejected: PO status → `Rejected` (order items remain `Planned`)

### 5. Confirmation to UP (Logistics Officer)
- After manager approval, LO confirms the PO
- Status: PO → `Confirmed to UP`
- All order items in PO → `Confirmed to UP`
- PO is sent to factory/manufacturer (UP)

### 6. Allocation Phase (Logistics Officer)
- UP tells LO to allocate quantities
- LO goes to order items with status `Confirmed to UP`
- Allocation options:
  - **Full Allocation**: Allocate the entire quantity
  - **Partial Allocation**: Allocate some quantity
    - If partial, two options:
      - **Push Remaining**: Push remaining quantity to a different month
        - Creates new order item with remaining quantity
        - New order item is linked to **same original PO**
        - Original order item status → `Partially Allocated`
        - New order item status → `Planned` (needs to be planned again)
      - **Remove Remaining**: Remove/cancel the remaining quantity
        - Original order item quantity is reduced
        - Status → `Fully Allocated`

### 7. Shipment
- After allocation, shipments can be created
- Status: `Shipped` → `Received`

## Status Flow Diagram

```
Forecasted (System)
    ↓
Planned (LO) → Link to PO
    ↓
PO: Approval Requested (LO)
    ↓
PO: Approved (Manager) or Rejected
    ↓
PO: Confirmed to UP (LO)
    ↓
Allocation (LO)
    ├─ Full Allocation → Fully Allocated
    └─ Partial Allocation
        ├─ Push to Different Month → New Order Item (Planned) + Original (Partially Allocated)
        └─ Remove Remaining → Fully Allocated (reduced quantity)
    ↓
Shipped → Received
```

## Data Model

### OrderItem
- `id`: Unique identifier
- `countryId`, `countryName`
- `skuId`, `skuName`
- `deliveryMonth`: Target delivery month
- `qtyCartons`: Quantity in cartons
- `status`: Forecasted | Planned | Confirmed to UP | Partially Allocated | Fully Allocated | Shipped | Received
- `poId`: Link to Purchase Order (null if not yet linked)
- `originalOrderItemId`: If pushed from another order item, reference to original
- `isSystemGenerated`: true if generated by Azure function
- `createdBy`, `createdOn`
- `modifiedBy`, `modifiedOn`
- `history`: Array of status changes

### PurchaseOrder (PO)
- `id`: Unique PO identifier (e.g., PO-2025-001)
- `status`: Draft | Approval Requested | Approved | Rejected | Confirmed to UP | Shipped | Received
- `orderItems`: Array of linked order item IDs
- `totalQtyCartons`: Sum of all order items
- `countries`: Array of countries in this PO
- `skus`: Array of SKUs in this PO
- `requestedBy`: LO who requested approval
- `requestedOn`: When approval was requested
- `approvedBy`: Manager who approved
- `approvedOn`: When approved
- `confirmedBy`: LO who confirmed to UP
- `confirmedOn`: When confirmed to UP
- `createdBy`, `createdOn`
- `modifiedBy`, `modifiedOn`
- `history`: Array of status changes

### Allocation
- `id`: Unique identifier
- `orderItemId`: Reference to order item
- `poId`: Reference to PO
- `allocatedQty`: Quantity allocated
- `remainingQty`: Remaining quantity (if partial)
- `allocationMonth`: Month allocated to
- `action`: Full | Partial | Push | Remove
- `pushedToOrderItemId`: If pushed, reference to new order item
- `allocatedBy`, `allocatedOn`

## User Roles

### Logistics Officer (LO)
- Views forecasted order items
- Plans order items (links to PO)
- Creates POs
- Requests PO approval
- Confirms PO to UP
- Allocates quantities
- Creates shipments

### Manager
- Reviews PO requests
- Approves or rejects POs
- Views all POs and their summaries

## Key Business Rules

1. **Order items must be linked to a PO before approval can be requested**
2. **Approval is always at PO level, never at order item level**
3. **When pushing remaining quantity to different month:**
   - New order item is created
   - Linked to same original PO
   - Status starts as `Planned` (needs planning again)
4. **Partial allocation creates two states:**
   - Original order item: `Partially Allocated`
   - New order item (if pushed): `Planned`
5. **PO cannot be confirmed to UP until manager approves**
6. **Allocation can only happen on order items with status `Confirmed to UP`**

